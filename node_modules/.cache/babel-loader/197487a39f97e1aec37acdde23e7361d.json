{"ast":null,"code":"var __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\nvar __generator = this && this.__generator || function (thisArg, body) {\n  var _ = {\n      label: 0,\n      sent: function () {\n        if (t[0] & 1) throw t[1];\n        return t[1];\n      },\n      trys: [],\n      ops: []\n    },\n    f,\n    y,\n    t,\n    g;\n  return g = {\n    next: verb(0),\n    \"throw\": verb(1),\n    \"return\": verb(2)\n  }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function () {\n    return this;\n  }), g;\n  function verb(n) {\n    return function (v) {\n      return step([n, v]);\n    };\n  }\n  function step(op) {\n    if (f) throw new TypeError(\"Generator is already executing.\");\n    while (_) try {\n      if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n      if (y = 0, t) op = [op[0] & 2, t.value];\n      switch (op[0]) {\n        case 0:\n        case 1:\n          t = op;\n          break;\n        case 4:\n          _.label++;\n          return {\n            value: op[1],\n            done: false\n          };\n        case 5:\n          _.label++;\n          y = op[1];\n          op = [0];\n          continue;\n        case 7:\n          op = _.ops.pop();\n          _.trys.pop();\n          continue;\n        default:\n          if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) {\n            _ = 0;\n            continue;\n          }\n          if (op[0] === 3 && (!t || op[1] > t[0] && op[1] < t[3])) {\n            _.label = op[1];\n            break;\n          }\n          if (op[0] === 6 && _.label < t[1]) {\n            _.label = t[1];\n            t = op;\n            break;\n          }\n          if (t && _.label < t[2]) {\n            _.label = t[2];\n            _.ops.push(op);\n            break;\n          }\n          if (t[2]) _.ops.pop();\n          _.trys.pop();\n          continue;\n      }\n      op = body.call(thisArg, _);\n    } catch (e) {\n      op = [6, e];\n      y = 0;\n    } finally {\n      f = t = 0;\n    }\n    if (op[0] & 5) throw op[1];\n    return {\n      value: op[0] ? op[1] : void 0,\n      done: true\n    };\n  }\n};\nvar __rest = this && this.__rest || function (s, e) {\n  var t = {};\n  for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0) t[p] = s[p];\n  if (s != null && typeof Object.getOwnPropertySymbols === \"function\") for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {\n    if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i])) t[p[i]] = s[p[i]];\n  }\n  return t;\n};\nimport { Mutex } from '@aws-amplify/core';\nimport * as PushStream from 'zen-push';\nimport { ModelPredicateCreator } from '../predicates';\nimport { OpType, QueryOne } from '../types';\nimport { isModelConstructor, STORAGE, validatePredicate } from '../util';\nimport getDefaultAdapter from './adapter/getDefaultAdapter';\nvar Storage = /** @class */function () {\n  function Storage(schema, namespaceResolver, getModelConstructorByModelName, modelInstanceCreator, adapter) {\n    this.schema = schema;\n    this.namespaceResolver = namespaceResolver;\n    this.getModelConstructorByModelName = getModelConstructorByModelName;\n    this.modelInstanceCreator = modelInstanceCreator;\n    this.adapter = adapter;\n    this.adapter = getDefaultAdapter();\n    this.pushStream = new PushStream();\n  }\n  Storage.getNamespace = function () {\n    var namespace = {\n      name: STORAGE,\n      relationships: {},\n      enums: {},\n      models: {},\n      nonModels: {}\n    };\n    return namespace;\n  };\n  Storage.prototype.init = function () {\n    return __awaiter(this, void 0, void 0, function () {\n      var resolve, reject;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            if (this.initialized !== undefined) {\n              return [2 /*return*/];\n            }\n            this.initialized = new Promise(function (res, rej) {\n              resolve = res;\n              reject = rej;\n            });\n            this.adapter.setUp(this.schema, this.namespaceResolver, this.modelInstanceCreator, this.getModelConstructorByModelName).then(resolve, reject);\n            return [4 /*yield*/, this.initialized];\n          case 1:\n            _a.sent();\n            return [2 /*return*/];\n        }\n      });\n    });\n  };\n  Storage.prototype.save = function (model, condition, mutator) {\n    return __awaiter(this, void 0, void 0, function () {\n      var result;\n      var _this = this;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            return [4 /*yield*/, this.init()];\n          case 1:\n            _a.sent();\n            return [4 /*yield*/, this.adapter.save(model, condition)];\n          case 2:\n            result = _a.sent();\n            result.forEach(function (r) {\n              var element = r[0],\n                opType = r[1];\n              var modelConstructor = Object.getPrototypeOf(element).constructor;\n              _this.pushStream.next({\n                model: modelConstructor,\n                opType: opType,\n                element: element,\n                mutator: mutator,\n                condition: ModelPredicateCreator.getPredicates(condition, false)\n              });\n            });\n            return [2 /*return*/, result];\n        }\n      });\n    });\n  };\n  Storage.prototype.delete = function (modelOrModelConstructor, condition, mutator) {\n    return __awaiter(this, void 0, void 0, function () {\n      var deleted, models, modelIds;\n      var _a;\n      var _this = this;\n      return __generator(this, function (_b) {\n        switch (_b.label) {\n          case 0:\n            return [4 /*yield*/, this.init()];\n          case 1:\n            _b.sent();\n            return [4 /*yield*/, this.adapter.delete(modelOrModelConstructor, condition)];\n          case 2:\n            _a = _b.sent(), models = _a[0], deleted = _a[1];\n            modelIds = new Set(models.map(function (_a) {\n              var id = _a.id;\n              return id;\n            }));\n            if (!isModelConstructor(modelOrModelConstructor) && !Array.isArray(deleted)) {\n              deleted = [deleted];\n            }\n            deleted.forEach(function (model) {\n              var modelConstructor = Object.getPrototypeOf(model).constructor;\n              var theCondition;\n              if (!isModelConstructor(modelOrModelConstructor)) {\n                theCondition = modelIds.has(model.id) ? ModelPredicateCreator.getPredicates(condition, false) : undefined;\n              }\n              _this.pushStream.next({\n                model: modelConstructor,\n                opType: OpType.DELETE,\n                element: model,\n                mutator: mutator,\n                condition: theCondition\n              });\n            });\n            return [2 /*return*/, [models, deleted]];\n        }\n      });\n    });\n  };\n  Storage.prototype.query = function (modelConstructor, predicate, pagination) {\n    return __awaiter(this, void 0, void 0, function () {\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            return [4 /*yield*/, this.init()];\n          case 1:\n            _a.sent();\n            return [4 /*yield*/, this.adapter.query(modelConstructor, predicate, pagination)];\n          case 2:\n            return [2 /*return*/, _a.sent()];\n        }\n      });\n    });\n  };\n  Storage.prototype.queryOne = function (modelConstructor, firstOrLast) {\n    if (firstOrLast === void 0) {\n      firstOrLast = QueryOne.FIRST;\n    }\n    return __awaiter(this, void 0, void 0, function () {\n      var record;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            return [4 /*yield*/, this.init()];\n          case 1:\n            _a.sent();\n            return [4 /*yield*/, this.adapter.queryOne(modelConstructor, firstOrLast)];\n          case 2:\n            record = _a.sent();\n            return [2 /*return*/, record];\n        }\n      });\n    });\n  };\n  Storage.prototype.observe = function (modelConstructor, predicate, skipOwn) {\n    var _a;\n    var listenToAll = !modelConstructor;\n    var hasPredicate = !!predicate;\n    var result = this.pushStream.observable.filter(function (_a) {\n      var mutator = _a.mutator;\n      return !skipOwn || mutator !== skipOwn;\n    }).map(function (_a) {\n      var _mutator = _a.mutator,\n        message = __rest(_a, [\"mutator\"]);\n      return message;\n    });\n    if (!listenToAll) {\n      var predicates_1, type_1;\n      if (hasPredicate) {\n        _a = ModelPredicateCreator.getPredicates(predicate), predicates_1 = _a.predicates, type_1 = _a.type;\n      }\n      result = result.filter(function (_a) {\n        var model = _a.model,\n          element = _a.element;\n        if (modelConstructor !== model) {\n          return false;\n        }\n        if (hasPredicate) {\n          return validatePredicate(element, type_1, predicates_1);\n        }\n        return true;\n      });\n    }\n    return result;\n  };\n  Storage.prototype.clear = function (completeObservable) {\n    if (completeObservable === void 0) {\n      completeObservable = true;\n    }\n    return __awaiter(this, void 0, void 0, function () {\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            this.initialized = undefined;\n            return [4 /*yield*/, this.adapter.clear()];\n          case 1:\n            _a.sent();\n            if (completeObservable) {\n              this.pushStream.complete();\n            }\n            return [2 /*return*/];\n        }\n      });\n    });\n  };\n  return Storage;\n}();\nvar ExclusiveStorage = /** @class */function () {\n  function ExclusiveStorage(schema, namespaceResolver, getModelConstructorByModelName, modelInstanceCreator, adapter) {\n    this.mutex = new Mutex();\n    this.storage = new Storage(schema, namespaceResolver, getModelConstructorByModelName, modelInstanceCreator, adapter);\n  }\n  ExclusiveStorage.prototype.runExclusive = function (fn) {\n    return this.mutex.runExclusive(fn.bind(this, this.storage));\n  };\n  ExclusiveStorage.prototype.save = function (model, condition, mutator) {\n    return __awaiter(this, void 0, void 0, function () {\n      return __generator(this, function (_a) {\n        return [2 /*return*/, this.runExclusive(function (storage) {\n          return storage.save(model, condition, mutator);\n        })];\n      });\n    });\n  };\n  ExclusiveStorage.prototype.delete = function (modelOrModelConstructor, condition, mutator) {\n    return __awaiter(this, void 0, void 0, function () {\n      return __generator(this, function (_a) {\n        return [2 /*return*/, this.runExclusive(function (storage) {\n          if (isModelConstructor(modelOrModelConstructor)) {\n            var modelConstructor = modelOrModelConstructor;\n            return storage.delete(modelConstructor, condition, mutator);\n          } else {\n            var model = modelOrModelConstructor;\n            return storage.delete(model, condition, mutator);\n          }\n        })];\n      });\n    });\n  };\n  ExclusiveStorage.prototype.query = function (modelConstructor, predicate, pagination) {\n    return __awaiter(this, void 0, void 0, function () {\n      return __generator(this, function (_a) {\n        return [2 /*return*/, this.runExclusive(function (storage) {\n          return storage.query(modelConstructor, predicate, pagination);\n        })];\n      });\n    });\n  };\n  ExclusiveStorage.prototype.queryOne = function (modelConstructor, firstOrLast) {\n    if (firstOrLast === void 0) {\n      firstOrLast = QueryOne.FIRST;\n    }\n    return __awaiter(this, void 0, void 0, function () {\n      return __generator(this, function (_a) {\n        return [2 /*return*/, this.runExclusive(function (storage) {\n          return storage.queryOne(modelConstructor, firstOrLast);\n        })];\n      });\n    });\n  };\n  ExclusiveStorage.getNamespace = function () {\n    return Storage.getNamespace();\n  };\n  ExclusiveStorage.prototype.observe = function (modelConstructor, predicate, skipOwn) {\n    return this.storage.observe(modelConstructor, predicate, skipOwn);\n  };\n  ExclusiveStorage.prototype.clear = function () {\n    return __awaiter(this, void 0, void 0, function () {\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            return [4 /*yield*/, this.storage.clear()];\n          case 1:\n            _a.sent();\n            return [2 /*return*/];\n        }\n      });\n    });\n  };\n  return ExclusiveStorage;\n}();\nexport default ExclusiveStorage;","map":{"version":3,"sources":["../../src/storage/storage.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,SAAS,KAAK,QAAQ,mBAAmB;AAEzC,OAAO,KAAK,UAAU,MAAM,UAAU;AAEtC,SAAS,qBAAqB,QAAQ,eAAe;AACrD,SAIC,MAAM,EAON,QAAQ,QAGF,UAAU;AACjB,SAAS,kBAAkB,EAAE,OAAO,EAAE,iBAAiB,QAAQ,SAAS;AAExE,OAAO,iBAAiB,MAAM,6BAA6B;AAQ3D,IAAA,OAAA,GAAA,aAAA,YAAA;EAMC,SAAA,OAAA,CACkB,MAAsB,EACtB,iBAAoC,EACpC,8BAGmB,EACnB,oBAA0C,EAC1C,OAAiB,EAAA;IAPjB,IAAA,CAAA,MAAM,GAAN,MAAM;IACN,IAAA,CAAA,iBAAiB,GAAjB,iBAAiB;IACjB,IAAA,CAAA,8BAA8B,GAA9B,8BAA8B;IAI9B,IAAA,CAAA,oBAAoB,GAApB,oBAAoB;IACpB,IAAA,CAAA,OAAO,GAAP,OAAO;IAExB,IAAI,CAAC,OAAO,GAAG,iBAAiB,CAAA,CAAE;IAClC,IAAI,CAAC,UAAU,GAAG,IAAI,UAAU,CAAA,CAAE;EACnC;EAEO,OAAA,CAAA,YAAY,GAAnB,YAAA;IACC,IAAM,SAAS,GAAoB;MAClC,IAAI,EAAE,OAAO;MACb,aAAa,EAAE,CAAA,CAAE;MACjB,KAAK,EAAE,CAAA,CAAE;MACT,MAAM,EAAE,CAAA,CAAE;MACV,SAAS,EAAE,CAAA;KACX;IAED,OAAO,SAAS;EACjB,CAAC;EAEa,OAAA,CAAA,SAAA,CAAA,IAAI,GAAlB,YAAA;;;;;;YACC,IAAI,IAAI,CAAC,WAAW,KAAK,SAAS,EAAE;cACnC,OAAA,CAAA,CAAA,CAAA,WAAA;YACA;YAID,IAAI,CAAC,WAAW,GAAG,IAAI,OAAO,CAAO,UAAC,GAAG,EAAE,GAAG,EAAA;cAC7C,OAAO,GAAG,GAAG;cACb,MAAM,GAAG,GAAG;YACb,CAAC,CAAC;YAEF,IAAI,CAAC,OAAO,CACV,KAAK,CACL,IAAI,CAAC,MAAM,EACX,IAAI,CAAC,iBAAiB,EACtB,IAAI,CAAC,oBAAoB,EACzB,IAAI,CAAC,8BAA8B,CACnC,CACA,IAAI,CAAC,OAAO,EAAE,MAAM,CAAC;YAEvB,OAAA,CAAA,CAAA,CAAA,WAAM,IAAI,CAAC,WAAW,CAAA;;YAAtB,EAAA,CAAA,IAAA,CAAA,CAAsB;;;;;GACtB;EAEK,OAAA,CAAA,SAAA,CAAA,IAAI,GAAV,UACC,KAAQ,EACR,SAA6B,EAC7B,OAAgB,EAAA;;;;;;;YAEhB,OAAA,CAAA,CAAA,CAAA,WAAM,IAAI,CAAC,IAAI,CAAA,CAAE,CAAA;;YAAjB,EAAA,CAAA,IAAA,CAAA,CAAiB;YAEF,OAAA,CAAA,CAAA,CAAA,WAAM,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,KAAK,EAAE,SAAS,CAAC,CAAA;;YAAlD,MAAM,GAAG,EAAA,CAAA,IAAA,CAAA,CAAyC;YAExD,MAAM,CAAC,OAAO,CAAC,UAAA,CAAC,EAAA;cACR,IAAA,OAAA,GAAA,CAAA,CAAA,CAAA,CAAO;gBAAE,MAAA,GAAA,CAAA,CAAA,CAAA,CAAM;cAEtB,IAAM,gBAAgB,GAAI,MAAM,CAAC,cAAc,CAAC,OAAO,CAAY,CACjE,WAA4C;cAE9C,KAAI,CAAC,UAAU,CAAC,IAAI,CAAC;gBACpB,KAAK,EAAE,gBAAgB;gBACvB,MAAM,EAAA,MAAA;gBACN,OAAO,EAAA,OAAA;gBACP,OAAO,EAAA,OAAA;gBACP,SAAS,EAAE,qBAAqB,CAAC,aAAa,CAAC,SAAS,EAAE,KAAK;eAC/D,CAAC;YACH,CAAC,CAAC;YAEF,OAAA,CAAA,CAAA,CAAA,YAAO,MAAM,CAAA;;;;GACb;EAYK,OAAA,CAAA,SAAA,CAAA,MAAM,GAAZ,UACC,uBAA0D,EAC1D,SAA6B,EAC7B,OAAgB,EAAA;;;;;;;;YAEhB,OAAA,CAAA,CAAA,CAAA,WAAM,IAAI,CAAC,IAAI,CAAA,CAAE,CAAA;;YAAjB,EAAA,CAAA,IAAA,CAAA,CAAiB;YAKG,OAAA,CAAA,CAAA,CAAA,WAAM,IAAI,CAAC,OAAO,CAAC,MAAM,CAC5C,uBAAuB,EACvB,SAAS,CACT,CAAA;;YAHD,EAAA,GAAA,EAAA,CAAA,IAAA,CAAA,CAGC,EAHA,MAAA,GAAA,EAAA,CAAA,CAAA,CAAM,EAAE,OAAA,GAAA,EAAA,CAAA,CAAA,CAAO;YAKV,QAAQ,GAAG,IAAI,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,UAAC,EAAM,EAAA;kBAAJ,EAAA,GAAA,EAAA,CAAA,EAAE;cAAO,OAAA,EAAE;YAAF,CAAE,CAAC,CAAC;YAEpD,IACC,CAAC,kBAAkB,CAAC,uBAAuB,CAAC,IAC5C,CAAC,KAAK,CAAC,OAAO,CAAC,OAAO,CAAC,EACtB;cACD,OAAO,GAAG,CAAC,OAAO,CAAC;YACnB;YAED,OAAO,CAAC,OAAO,CAAC,UAAA,KAAK,EAAA;cACpB,IAAM,gBAAgB,GAAI,MAAM,CAAC,cAAc,CAAC,KAAK,CAAY,CAC/D,WAA4C;cAE9C,IAAI,YAAkC;cAEtC,IAAI,CAAC,kBAAkB,CAAC,uBAAuB,CAAC,EAAE;gBACjD,YAAY,GAAG,QAAQ,CAAC,GAAG,CAAC,KAAK,CAAC,EAAE,CAAC,GAClC,qBAAqB,CAAC,aAAa,CAAC,SAAS,EAAE,KAAK,CAAC,GACrD,SAAS;cACZ;cAED,KAAI,CAAC,UAAU,CAAC,IAAI,CAAC;gBACpB,KAAK,EAAE,gBAAgB;gBACvB,MAAM,EAAE,MAAM,CAAC,MAAM;gBACrB,OAAO,EAAE,KAAK;gBACd,OAAO,EAAA,OAAA;gBACP,SAAS,EAAE;eACX,CAAC;YACH,CAAC,CAAC;YAEF,OAAA,CAAA,CAAA,CAAA,YAAO,CAAC,MAAM,EAAE,OAAO,CAAC,CAAA;;;;GACxB;EAEK,OAAA,CAAA,SAAA,CAAA,KAAK,GAAX,UACC,gBAA+C,EAC/C,SAA6B,EAC7B,UAA4B,EAAA;;;;;YAE5B,OAAA,CAAA,CAAA,CAAA,WAAM,IAAI,CAAC,IAAI,CAAA,CAAE,CAAA;;YAAjB,EAAA,CAAA,IAAA,CAAA,CAAiB;YAEV,OAAA,CAAA,CAAA,CAAA,WAAM,IAAI,CAAC,OAAO,CAAC,KAAK,CAAC,gBAAgB,EAAE,SAAS,EAAE,UAAU,CAAC,CAAA;;YAAxE,OAAA,CAAA,CAAA,CAAA,YAAO,EAAA,CAAA,IAAA,CAAA,CAAiE,CAAA;;;;GACxE;EAEK,OAAA,CAAA,SAAA,CAAA,QAAQ,GAAd,UACC,gBAA+C,EAC/C,WAAsC,EAAA;IAAtC,IAAA,WAAA,KAAA,KAAA,CAAA,EAAA;MAAA,WAAA,GAAwB,QAAQ,CAAC,KAAK;IAAA;;;;;;YAEtC,OAAA,CAAA,CAAA,CAAA,WAAM,IAAI,CAAC,IAAI,CAAA,CAAE,CAAA;;YAAjB,EAAA,CAAA,IAAA,CAAA,CAAiB;YAEF,OAAA,CAAA,CAAA,CAAA,WAAM,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,gBAAgB,EAAE,WAAW,CAAC,CAAA;;YAAnE,MAAM,GAAG,EAAA,CAAA,IAAA,CAAA,CAA0D;YACzE,OAAA,CAAA,CAAA,CAAA,YAAO,MAAM,CAAA;;;;GACb;EAED,OAAA,CAAA,SAAA,CAAA,OAAO,GAAP,UACC,gBAAgD,EAChD,SAA6B,EAC7B,OAAgB,EAAA;;IAEhB,IAAM,WAAW,GAAG,CAAC,gBAAgB;IACrC,IAAM,YAAY,GAAG,CAAC,CAAC,SAAS;IAEhC,IAAI,MAAM,GAAG,IAAI,CAAC,UAAU,CAAC,UAAU,CACrC,MAAM,CAAC,UAAC,EAAW,EAAA;UAAT,OAAA,GAAA,EAAA,CAAA,OAAO;MACjB,OAAO,CAAC,OAAO,IAAI,OAAO,KAAK,OAAO;IACvC,CAAC,CAAC,CACD,GAAG,CAAC,UAAC,EAAiC,EAAA;MAA/B,IAAA,QAAA,GAAA,EAAA,CAAA,OAAiB;QAAE,OAAA,GAAA,MAAA,CAAA,EAAA,EAAA,CAAA,SAAA,CAAA,CAAU;MAAO,OAAA,OAAO;KAAA,CAAC;IAErD,IAAI,CAAC,WAAW,EAAE;MACjB,IAAI,YAAuD,EAC1D,MAA8B;MAE/B,IAAI,YAAY,EAAE;QAChB,EAAA,GAAA,qBAAA,CAAA,aAAA,CAAA,SAAA,CAAqE,EAAnE,YAAA,GAAA,EAAA,CAAA,UAAU,EAAE,MAAA,GAAA,EAAA,CAAA,IAAI;MACnB;MAED,MAAM,GAAG,MAAM,CAAC,MAAM,CAAC,UAAC,EAAkB,EAAA;YAAhB,KAAA,GAAA,EAAA,CAAA,KAAK;UAAE,OAAA,GAAA,EAAA,CAAA,OAAO;QACvC,IAAI,gBAAgB,KAAK,KAAK,EAAE;UAC/B,OAAO,KAAK;QACZ;QAED,IAAI,YAAY,EAAE;UACjB,OAAO,iBAAiB,CAAC,OAAO,EAAE,MAAI,EAAE,YAAU,CAAC;QACnD;QAED,OAAO,IAAI;MACZ,CAAC,CAAC;IACF;IAED,OAAO,MAAM;EACd,CAAC;EAEK,OAAA,CAAA,SAAA,CAAA,KAAK,GAAX,UAAY,kBAAyB,EAAA;IAAzB,IAAA,kBAAA,KAAA,KAAA,CAAA,EAAA;MAAA,kBAAA,GAAA,IAAyB;IAAA;;;;;YACpC,IAAI,CAAC,WAAW,GAAG,SAAS;YAE5B,OAAA,CAAA,CAAA,CAAA,WAAM,IAAI,CAAC,OAAO,CAAC,KAAK,CAAA,CAAE,CAAA;;YAA1B,EAAA,CAAA,IAAA,CAAA,CAA0B;YAE1B,IAAI,kBAAkB,EAAE;cACvB,IAAI,CAAC,UAAU,CAAC,QAAQ,CAAA,CAAE;YAC1B;;;;;GACD;EACF,OAAA,OAAC;AAAD,CAAC,CAAA,CAAA;AAED,IAAA,gBAAA,GAAA,aAAA,YAAA;EAGC,SAAA,gBAAA,CACC,MAAsB,EACtB,iBAAoC,EACpC,8BAGoC,EACpC,oBAA0C,EAC1C,OAAiB,EAAA;IATD,IAAA,CAAA,KAAK,GAAG,IAAI,KAAK,CAAA,CAAE;IAWnC,IAAI,CAAC,OAAO,GAAG,IAAI,OAAO,CACzB,MAAM,EACN,iBAAiB,EACjB,8BAA8B,EAC9B,oBAAoB,EACpB,OAAO,CACP;EACF;EAEA,gBAAA,CAAA,SAAA,CAAA,YAAY,GAAZ,UAAgB,EAAoC,EAAA;IACnD,OAAmB,IAAI,CAAC,KAAK,CAAC,YAAY,CAAC,EAAE,CAAC,IAAI,CAAC,IAAI,EAAE,IAAI,CAAC,OAAO,CAAC,CAAC;EACxE,CAAC;EAEK,gBAAA,CAAA,SAAA,CAAA,IAAI,GAAV,UACC,KAAQ,EACR,SAA6B,EAC7B,OAAgB,EAAA;;;QAEhB,OAAA,CAAA,CAAA,CAAA,YAAO,IAAI,CAAC,YAAY,CAAuC,UAAA,OAAO,EAAA;UACrE,OAAA,OAAO,CAAC,IAAI,CAAI,KAAK,EAAE,SAAS,EAAE,OAAO,CAAC;QAA1C,CAA0C,CAC1C,CAAA;;;GACD;EAYK,gBAAA,CAAA,SAAA,CAAA,MAAM,GAAZ,UACC,uBAA0D,EAC1D,SAA6B,EAC7B,OAAgB,EAAA;;;QAEhB,OAAA,CAAA,CAAA,CAAA,YAAO,IAAI,CAAC,YAAY,CAAa,UAAA,OAAO,EAAA;UAC3C,IAAI,kBAAkB,CAAC,uBAAuB,CAAC,EAAE;YAChD,IAAM,gBAAgB,GAAG,uBAAuB;YAEhD,OAAO,OAAO,CAAC,MAAM,CAAC,gBAAgB,EAAE,SAAS,EAAE,OAAO,CAAC;WAC3D,MAAM;YACN,IAAM,KAAK,GAAG,uBAAuB;YAErC,OAAO,OAAO,CAAC,MAAM,CAAC,KAAK,EAAE,SAAS,EAAE,OAAO,CAAC;UAChD;QACF,CAAC,CAAC,CAAA;;;GACF;EAEK,gBAAA,CAAA,SAAA,CAAA,KAAK,GAAX,UACC,gBAA+C,EAC/C,SAA6B,EAC7B,UAA4B,EAAA;;;QAE5B,OAAA,CAAA,CAAA,CAAA,YAAO,IAAI,CAAC,YAAY,CAAM,UAAA,OAAO,EAAA;UACpC,OAAA,OAAO,CAAC,KAAK,CAAI,gBAAgB,EAAE,SAAS,EAAE,UAAU,CAAC;QAAzD,CAAyD,CACzD,CAAA;;;GACD;EAEK,gBAAA,CAAA,SAAA,CAAA,QAAQ,GAAd,UACC,gBAA+C,EAC/C,WAAsC,EAAA;IAAtC,IAAA,WAAA,KAAA,KAAA,CAAA,EAAA;MAAA,WAAA,GAAwB,QAAQ,CAAC,KAAK;IAAA;;;QAEtC,OAAA,CAAA,CAAA,CAAA,YAAO,IAAI,CAAC,YAAY,CAAI,UAAA,OAAO,EAAA;UAClC,OAAA,OAAO,CAAC,QAAQ,CAAI,gBAAgB,EAAE,WAAW,CAAC;QAAlD,CAAkD,CAClD,CAAA;;;GACD;EAEM,gBAAA,CAAA,YAAY,GAAnB,YAAA;IACC,OAAO,OAAO,CAAC,YAAY,CAAA,CAAE;EAC9B,CAAC;EAED,gBAAA,CAAA,SAAA,CAAA,OAAO,GAAP,UACC,gBAAgD,EAChD,SAA6B,EAC7B,OAAgB,EAAA;IAEhB,OAAO,IAAI,CAAC,OAAO,CAAC,OAAO,CAAC,gBAAgB,EAAE,SAAS,EAAE,OAAO,CAAC;EAClE,CAAC;EAEK,gBAAA,CAAA,SAAA,CAAA,KAAK,GAAX,YAAA;;;;;YACC,OAAA,CAAA,CAAA,CAAA,WAAM,IAAI,CAAC,OAAO,CAAC,KAAK,CAAA,CAAE,CAAA;;YAA1B,EAAA,CAAA,IAAA,CAAA,CAA0B;;;;;GAC1B;EACF,OAAA,gBAAC;AAAD,CAAC,CAAA,CAAA;AAED,eAAe,gBAAgB","sourceRoot":"","sourcesContent":["var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nvar __generator = (this && this.__generator) || function (thisArg, body) {\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\n    function verb(n) { return function (v) { return step([n, v]); }; }\n    function step(op) {\n        if (f) throw new TypeError(\"Generator is already executing.\");\n        while (_) try {\n            if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n            if (y = 0, t) op = [op[0] & 2, t.value];\n            switch (op[0]) {\n                case 0: case 1: t = op; break;\n                case 4: _.label++; return { value: op[1], done: false };\n                case 5: _.label++; y = op[1]; op = [0]; continue;\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\n                default:\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\n                    if (t[2]) _.ops.pop();\n                    _.trys.pop(); continue;\n            }\n            op = body.call(thisArg, _);\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\n    }\n};\nvar __rest = (this && this.__rest) || function (s, e) {\n    var t = {};\n    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)\n        t[p] = s[p];\n    if (s != null && typeof Object.getOwnPropertySymbols === \"function\")\n        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {\n            if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))\n                t[p[i]] = s[p[i]];\n        }\n    return t;\n};\nimport { Mutex } from '@aws-amplify/core';\nimport * as PushStream from 'zen-push';\nimport { ModelPredicateCreator } from '../predicates';\nimport { OpType, QueryOne, } from '../types';\nimport { isModelConstructor, STORAGE, validatePredicate } from '../util';\nimport getDefaultAdapter from './adapter/getDefaultAdapter';\nvar Storage = /** @class */ (function () {\n    function Storage(schema, namespaceResolver, getModelConstructorByModelName, modelInstanceCreator, adapter) {\n        this.schema = schema;\n        this.namespaceResolver = namespaceResolver;\n        this.getModelConstructorByModelName = getModelConstructorByModelName;\n        this.modelInstanceCreator = modelInstanceCreator;\n        this.adapter = adapter;\n        this.adapter = getDefaultAdapter();\n        this.pushStream = new PushStream();\n    }\n    Storage.getNamespace = function () {\n        var namespace = {\n            name: STORAGE,\n            relationships: {},\n            enums: {},\n            models: {},\n            nonModels: {},\n        };\n        return namespace;\n    };\n    Storage.prototype.init = function () {\n        return __awaiter(this, void 0, void 0, function () {\n            var resolve, reject;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        if (this.initialized !== undefined) {\n                            return [2 /*return*/];\n                        }\n                        this.initialized = new Promise(function (res, rej) {\n                            resolve = res;\n                            reject = rej;\n                        });\n                        this.adapter\n                            .setUp(this.schema, this.namespaceResolver, this.modelInstanceCreator, this.getModelConstructorByModelName)\n                            .then(resolve, reject);\n                        return [4 /*yield*/, this.initialized];\n                    case 1:\n                        _a.sent();\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    Storage.prototype.save = function (model, condition, mutator) {\n        return __awaiter(this, void 0, void 0, function () {\n            var result;\n            var _this = this;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0: return [4 /*yield*/, this.init()];\n                    case 1:\n                        _a.sent();\n                        return [4 /*yield*/, this.adapter.save(model, condition)];\n                    case 2:\n                        result = _a.sent();\n                        result.forEach(function (r) {\n                            var element = r[0], opType = r[1];\n                            var modelConstructor = Object.getPrototypeOf(element)\n                                .constructor;\n                            _this.pushStream.next({\n                                model: modelConstructor,\n                                opType: opType,\n                                element: element,\n                                mutator: mutator,\n                                condition: ModelPredicateCreator.getPredicates(condition, false),\n                            });\n                        });\n                        return [2 /*return*/, result];\n                }\n            });\n        });\n    };\n    Storage.prototype.delete = function (modelOrModelConstructor, condition, mutator) {\n        return __awaiter(this, void 0, void 0, function () {\n            var deleted, models, modelIds;\n            var _a;\n            var _this = this;\n            return __generator(this, function (_b) {\n                switch (_b.label) {\n                    case 0: return [4 /*yield*/, this.init()];\n                    case 1:\n                        _b.sent();\n                        return [4 /*yield*/, this.adapter.delete(modelOrModelConstructor, condition)];\n                    case 2:\n                        _a = _b.sent(), models = _a[0], deleted = _a[1];\n                        modelIds = new Set(models.map(function (_a) {\n                            var id = _a.id;\n                            return id;\n                        }));\n                        if (!isModelConstructor(modelOrModelConstructor) &&\n                            !Array.isArray(deleted)) {\n                            deleted = [deleted];\n                        }\n                        deleted.forEach(function (model) {\n                            var modelConstructor = Object.getPrototypeOf(model)\n                                .constructor;\n                            var theCondition;\n                            if (!isModelConstructor(modelOrModelConstructor)) {\n                                theCondition = modelIds.has(model.id)\n                                    ? ModelPredicateCreator.getPredicates(condition, false)\n                                    : undefined;\n                            }\n                            _this.pushStream.next({\n                                model: modelConstructor,\n                                opType: OpType.DELETE,\n                                element: model,\n                                mutator: mutator,\n                                condition: theCondition,\n                            });\n                        });\n                        return [2 /*return*/, [models, deleted]];\n                }\n            });\n        });\n    };\n    Storage.prototype.query = function (modelConstructor, predicate, pagination) {\n        return __awaiter(this, void 0, void 0, function () {\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0: return [4 /*yield*/, this.init()];\n                    case 1:\n                        _a.sent();\n                        return [4 /*yield*/, this.adapter.query(modelConstructor, predicate, pagination)];\n                    case 2: return [2 /*return*/, _a.sent()];\n                }\n            });\n        });\n    };\n    Storage.prototype.queryOne = function (modelConstructor, firstOrLast) {\n        if (firstOrLast === void 0) { firstOrLast = QueryOne.FIRST; }\n        return __awaiter(this, void 0, void 0, function () {\n            var record;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0: return [4 /*yield*/, this.init()];\n                    case 1:\n                        _a.sent();\n                        return [4 /*yield*/, this.adapter.queryOne(modelConstructor, firstOrLast)];\n                    case 2:\n                        record = _a.sent();\n                        return [2 /*return*/, record];\n                }\n            });\n        });\n    };\n    Storage.prototype.observe = function (modelConstructor, predicate, skipOwn) {\n        var _a;\n        var listenToAll = !modelConstructor;\n        var hasPredicate = !!predicate;\n        var result = this.pushStream.observable\n            .filter(function (_a) {\n            var mutator = _a.mutator;\n            return !skipOwn || mutator !== skipOwn;\n        })\n            .map(function (_a) {\n            var _mutator = _a.mutator, message = __rest(_a, [\"mutator\"]);\n            return message;\n        });\n        if (!listenToAll) {\n            var predicates_1, type_1;\n            if (hasPredicate) {\n                (_a = ModelPredicateCreator.getPredicates(predicate), predicates_1 = _a.predicates, type_1 = _a.type);\n            }\n            result = result.filter(function (_a) {\n                var model = _a.model, element = _a.element;\n                if (modelConstructor !== model) {\n                    return false;\n                }\n                if (hasPredicate) {\n                    return validatePredicate(element, type_1, predicates_1);\n                }\n                return true;\n            });\n        }\n        return result;\n    };\n    Storage.prototype.clear = function (completeObservable) {\n        if (completeObservable === void 0) { completeObservable = true; }\n        return __awaiter(this, void 0, void 0, function () {\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        this.initialized = undefined;\n                        return [4 /*yield*/, this.adapter.clear()];\n                    case 1:\n                        _a.sent();\n                        if (completeObservable) {\n                            this.pushStream.complete();\n                        }\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    return Storage;\n}());\nvar ExclusiveStorage = /** @class */ (function () {\n    function ExclusiveStorage(schema, namespaceResolver, getModelConstructorByModelName, modelInstanceCreator, adapter) {\n        this.mutex = new Mutex();\n        this.storage = new Storage(schema, namespaceResolver, getModelConstructorByModelName, modelInstanceCreator, adapter);\n    }\n    ExclusiveStorage.prototype.runExclusive = function (fn) {\n        return this.mutex.runExclusive(fn.bind(this, this.storage));\n    };\n    ExclusiveStorage.prototype.save = function (model, condition, mutator) {\n        return __awaiter(this, void 0, void 0, function () {\n            return __generator(this, function (_a) {\n                return [2 /*return*/, this.runExclusive(function (storage) {\n                        return storage.save(model, condition, mutator);\n                    })];\n            });\n        });\n    };\n    ExclusiveStorage.prototype.delete = function (modelOrModelConstructor, condition, mutator) {\n        return __awaiter(this, void 0, void 0, function () {\n            return __generator(this, function (_a) {\n                return [2 /*return*/, this.runExclusive(function (storage) {\n                        if (isModelConstructor(modelOrModelConstructor)) {\n                            var modelConstructor = modelOrModelConstructor;\n                            return storage.delete(modelConstructor, condition, mutator);\n                        }\n                        else {\n                            var model = modelOrModelConstructor;\n                            return storage.delete(model, condition, mutator);\n                        }\n                    })];\n            });\n        });\n    };\n    ExclusiveStorage.prototype.query = function (modelConstructor, predicate, pagination) {\n        return __awaiter(this, void 0, void 0, function () {\n            return __generator(this, function (_a) {\n                return [2 /*return*/, this.runExclusive(function (storage) {\n                        return storage.query(modelConstructor, predicate, pagination);\n                    })];\n            });\n        });\n    };\n    ExclusiveStorage.prototype.queryOne = function (modelConstructor, firstOrLast) {\n        if (firstOrLast === void 0) { firstOrLast = QueryOne.FIRST; }\n        return __awaiter(this, void 0, void 0, function () {\n            return __generator(this, function (_a) {\n                return [2 /*return*/, this.runExclusive(function (storage) {\n                        return storage.queryOne(modelConstructor, firstOrLast);\n                    })];\n            });\n        });\n    };\n    ExclusiveStorage.getNamespace = function () {\n        return Storage.getNamespace();\n    };\n    ExclusiveStorage.prototype.observe = function (modelConstructor, predicate, skipOwn) {\n        return this.storage.observe(modelConstructor, predicate, skipOwn);\n    };\n    ExclusiveStorage.prototype.clear = function () {\n        return __awaiter(this, void 0, void 0, function () {\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0: return [4 /*yield*/, this.storage.clear()];\n                    case 1:\n                        _a.sent();\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    return ExclusiveStorage;\n}());\nexport default ExclusiveStorage;\n//# sourceMappingURL=storage.js.map"]},"metadata":{},"sourceType":"module"}